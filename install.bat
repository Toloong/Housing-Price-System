@echo off
setlocal EnableDelayedExpansion
chcp 65001 >nul
title æˆ¿ä»·åˆ†æç³»ç»Ÿ - Windowsä¸€é”®å®‰è£…

echo.
echo    â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
echo    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• 
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—
echo    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘
echo    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
echo    â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â•  â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• 
echo.
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
echo    â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  
echo    â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo    â•šâ•â•     â•šâ•â•  â•šâ•â•â•šâ•â• â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
echo.
echo         æˆ¿ä»·åˆ†æç³»ç»Ÿ v3.0 - Windowsä¸€é”®å®‰è£…ç¨‹åº
echo    ===================================================
echo.

REM æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if not exist "requirements.txt" (
    echo âŒ é”™è¯¯ï¼šè¯·åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬
    echo    å½“å‰ç›®å½•åº”åŒ…å« requirements.txt æ–‡ä»¶
    echo.
    pause
    exit /b 1
)

echo ğŸš€ æ¬¢è¿ä½¿ç”¨æˆ¿ä»·åˆ†æç³»ç»Ÿï¼
echo.
echo æœ¬ç¨‹åºå°†ä¸ºæ‚¨è‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š
echo   âœ“ æ£€æŸ¥å¹¶å®‰è£…Pythonä¾èµ–
echo   âœ“ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ  
echo   âœ“ é…ç½®æ•°æ®åº“^(å¯é€‰^)
echo   âœ“ å¯åŠ¨åº”ç”¨ç³»ç»Ÿ
echo.

set /p confirm=æ˜¯å¦ç»§ç»­å®‰è£…ï¼Ÿ ^(Y/N^): 
if /i not "%confirm%"=="Y" (
    echo ğŸ‘‹ å®‰è£…å·²å–æ¶ˆ
    pause
    exit /b 0
)

echo.
echo ====================================================
echo                   å¼€å§‹å®‰è£…
echo ====================================================
echo.

REM æ£€æŸ¥Python
echo ğŸ æ£€æŸ¥Pythonç¯å¢ƒ...
python --version >nul 2>&1
if %errorlevel% neq 0 (
    echo âŒ Pythonæœªå®‰è£…
    echo.
    echo ğŸ“¥ è¯·å…ˆå®‰è£…Pythonï¼š
    echo    1. è®¿é—® https://python.org
    echo    2. ä¸‹è½½Python 3.8æˆ–æ›´é«˜ç‰ˆæœ¬
    echo    3. å®‰è£…æ—¶å‹¾é€‰"Add to PATH"
    echo    4. é‡æ–°è¿è¡Œæ­¤è„šæœ¬
    echo.
    pause
    exit /b 1
)

for /f "tokens=2" %%a in ('python --version 2^>^&1') do set python_version=%%a
echo âœ… Pythonå·²å®‰è£…: %python_version%

REM åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
echo.
echo ğŸ“¦ è®¾ç½®è™šæ‹Ÿç¯å¢ƒ...
if exist ".venv" (
    echo âœ… è™šæ‹Ÿç¯å¢ƒå·²å­˜åœ¨
) else (
    echo ğŸ”§ åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ...
    python -m venv .venv
    if %errorlevel% neq 0 (
        echo âŒ è™šæ‹Ÿç¯å¢ƒåˆ›å»ºå¤±è´¥
        pause
        exit /b 1
    )
    echo âœ… è™šæ‹Ÿç¯å¢ƒåˆ›å»ºæˆåŠŸ
)

REM æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
echo ğŸ”Œ æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ...
call .venv\Scripts\activate.bat
if %errorlevel% neq 0 (
    echo âŒ è™šæ‹Ÿç¯å¢ƒæ¿€æ´»å¤±è´¥
    pause
    exit /b 1
)
echo âœ… è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»

REM å®‰è£…ä¾èµ–
echo.
echo ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–...
echo    è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...
pip install -r requirements.txt
if %errorlevel% neq 0 (
    echo âŒ ä¾èµ–å®‰è£…å¤±è´¥
    echo.
    echo ğŸ’¡ å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼š
    echo    1. æ£€æŸ¥ç½‘ç»œè¿æ¥
    echo    2. å‡çº§pip: python -m pip install --upgrade pip
    echo    3. ä½¿ç”¨å›½å†…é•œåƒ: pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    echo.
    pause
    exit /b 1
)
echo âœ… ä¾èµ–å®‰è£…å®Œæˆ

REM æ•°æ®åº“é…ç½®é€‰æ‹©
echo.
echo ====================================================
echo                  æ•°æ®åº“é…ç½®
echo ====================================================
echo.
echo ğŸ” ç”¨æˆ·ç®¡ç†åŠŸèƒ½éœ€è¦PostgreSQLæ•°æ®åº“æ”¯æŒ
echo.
echo é€‰æ‹©æ“ä½œï¼š
echo   1. é…ç½®PostgreSQL^(æ¨èï¼Œæ”¯æŒå®Œæ•´åŠŸèƒ½^)
echo   2. è·³è¿‡æ•°æ®åº“é…ç½®^(ä»…åŸºç¡€åŠŸèƒ½^)
echo.

set /p db_choice=è¯·é€‰æ‹© ^(1-2^): 

if "%db_choice%"=="1" (
    echo.
    echo ğŸ˜ å¼€å§‹é…ç½®PostgreSQL...
    
    REM æ£€æŸ¥PostgreSQLæ˜¯å¦å®‰è£…
    psql --version >nul 2>&1
    if %errorlevel% neq 0 (
        echo âš ï¸  PostgreSQLæœªæ£€æµ‹åˆ°
        echo.
        echo ğŸ“¥ è¯·å®‰è£…PostgreSQLï¼š
        echo    1. è®¿é—® https://www.postgresql.org/download/windows/
        echo    2. ä¸‹è½½å¹¶å®‰è£…PostgreSQL 12+
        echo    3. è®°ä½postgresç”¨æˆ·å¯†ç 
        echo    4. é‡æ–°è¿è¡Œæ­¤è„šæœ¬
        echo.
        set /p skip_db=æ˜¯å¦è·³è¿‡æ•°æ®åº“é…ç½®ç»§ç»­å®‰è£…ï¼Ÿ ^(Y/N^): 
        if /i "!skip_db!"=="Y" (
            echo â­ï¸  è·³è¿‡æ•°æ®åº“é…ç½®
        ) else (
            pause
            exit /b 1
        )
    ) else (
        echo âœ… PostgreSQLå·²å®‰è£…
        echo ğŸ”§ è¿è¡Œæ•°æ®åº“é…ç½®è„šæœ¬...
        
        if exist "setup_postgresql_simple.ps1" (
            powershell -ExecutionPolicy Bypass -Command "& {Set-ExecutionPolicy Bypass -Scope Process; .\setup_postgresql_simple.ps1}"
        ) else if exist "setup_postgresql.ps1" (
            powershell -ExecutionPolicy Bypass -Command "& {Set-ExecutionPolicy Bypass -Scope Process; .\setup_postgresql.ps1}"
        ) else (
            echo ğŸ”§ æ‰‹åŠ¨é…ç½®æ•°æ®åº“...
            python init_database.py
        )
    )
) else (
    echo â­ï¸  è·³è¿‡æ•°æ®åº“é…ç½®ï¼Œå°†ä»…æä¾›åŸºç¡€åŠŸèƒ½
)

REM å®‰è£…å®Œæˆ
echo.
echo ====================================================
echo                  å®‰è£…å®Œæˆï¼
echo ====================================================
echo.
echo âœ… æˆ¿ä»·åˆ†æç³»ç»Ÿå®‰è£…æˆåŠŸï¼
echo.
echo ğŸŒŸ åŠŸèƒ½ç‰¹æ€§ï¼š
echo    â€¢ ğŸ  æˆ¿ä»·æŸ¥è¯¢å’Œæœç´¢
echo    â€¢ ğŸ“ˆ è¶‹åŠ¿åˆ†æå’Œå¯è§†åŒ–  
echo    â€¢ ğŸ™ï¸ åŸå¸‚å¯¹æ¯”åˆ†æ
echo    â€¢ ğŸ¤– AIæ™ºèƒ½åŠ©æ‰‹
if "%db_choice%"=="1" (
    echo    â€¢ ğŸ‘¥ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ^(å·²é…ç½®^)
) else (
    echo    â€¢ ğŸ‘¥ ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ ^(æœªé…ç½®^)
)
echo.
echo ğŸš€ ç°åœ¨å¯åŠ¨ç³»ç»Ÿï¼Ÿ
set /p start_now=ç«‹å³å¯åŠ¨åº”ç”¨ ^(Y/N^): 

if /i "%start_now%"=="Y" (
    echo.
    echo ğŸ¯ å¯åŠ¨ç³»ç»Ÿ...
    call start_system.bat
) else (
    echo.
    echo ğŸ“– æ‰‹åŠ¨å¯åŠ¨è¯´æ˜ï¼š
    echo    1. åŒå‡» start_system.bat
    echo    2. æˆ–è¿è¡Œ .\start_system.ps1
    echo.
    echo ğŸŒ è®¿é—®åœ°å€ï¼š
    echo    å‰ç«¯åº”ç”¨: http://localhost:8501
    echo    åç«¯API: http://localhost:8000
    echo.
    echo ğŸ“š æ›´å¤šå¸®åŠ©è¯·æŸ¥çœ‹ WINDOWS_GUIDE.md
)

echo.
echo æ„Ÿè°¢ä½¿ç”¨æˆ¿ä»·åˆ†æç³»ç»Ÿï¼ ğŸ‰
pause
